name: Docker Image CI

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 1'

env:
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_ACCESSTOKEN }}
  ALIYUN_IMAGE_TOKEN: ${{ secrets.ALIYUN_IMAGE_ACCESSTOKEN }}

jobs:
  build:
    name: build ${{ matrix.php-version }} - ${{ matrix.platform }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version:
          - 7.4
          - 8.0
        platform:
          - alpine
          - bullseye
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Build the Docker image version
      run: |
        docker build -t yansongda/php-fpm:${{ matrix.php-version }}-${{ matrix.platform }} -f ${{ matrix.platform }}/Dockerfile ./${{ matrix.php-version }}
        docker tag yansongda/php-fpm:${{ matrix.php-version }}-${{ matrix.platform }} registry.cn-shenzhen.aliyuncs.com/yansongda/php-fpm:${{ matrix.php-version }}-${{ matrix.platform }}
    - name: Push Image to Docker Registry
      run: |
        docker login --username yansongda -p ${{ secrets.DOCKERHUB_ACCESSTOKEN }}
        docker push yansongda/php-fpm:${{ matrix.php-version }}-${{ matrix.platform }}
    - name: Push Image to Aliyun Registry
      run: |
        docker login --username=me@yansongda.cn registry.cn-shenzhen.aliyuncs.com -p ${{ secrets.ALIYUN_IMAGE_ACCESSTOKEN }}
        docker push registry.cn-shenzhen.aliyuncs.com/yansongda/php-fpm:${{ matrix.php-version }}-${{ matrix.platform }}
